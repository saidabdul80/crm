import{a2 as W,v as G,$ as x,u as P,g as y,F as U,D as E,e as O,l as w,h as j,i as A,k as Y,r as c,o as L,n as F,w as l,b as D,q as $,t as S,m as s,a as o,H as R,I as Z,s as ee,a6 as te,c as ae,L as se}from"./main-9a914193.js";import{u as H}from"./disk-384154c9.js";const X=(I=!1)=>{const m=I?window.pinia.defineStore:W,{global:_}=window.i18n;return m({id:"backup",state:()=>({backups:[],currentBackupData:{option:"full",selected_disk:null}}),actions:{fetchBackups(f){return new Promise((n,a)=>{G.get("/api/v1/backups",{params:f,headers:{Authorization:`Bearer ${localStorage.getItem("auth.token")}`}}).then(e=>{this.backups=e.data.data,n(e)}).catch(e=>{x(e),a(e)})})},createBackup(f){return new Promise((n,a)=>{G.post("/api/v1/backups",f,{headers:{Authorization:`Bearer ${localStorage.getItem("auth.token")}`}}).then(e=>{P().showNotification({type:"success",message:_.t("settings.backup.created_message")}),n(e)}).catch(e=>{x(e),a(e)})})},removeBackup(f){return new Promise((n,a)=>{G.delete(`/api/v1/backups/${f.disk}`,{params:f,headers:{Authorization:`Bearer ${localStorage.getItem("auth.token")}`}}).then(e=>{P().showNotification({type:"success",message:_.t("settings.backup.deleted_message")}),n(e)}).catch(e=>{x(e),a(e)})})}}})()},oe={class:"flex justify-between w-full"},ne=["onSubmit"],le={class:"p-6"},re={class:"z-0 flex justify-end p-4 border-t border-gray-200 border-solid"},ce={setup(I){y(null),y(!1);let m=y(!1),_=y(!1);const f=U(["full","only-db","only-files"]),n=X(),a=E(),e=H(),{t:p}=O(),k=w(()=>a.active&&a.componentName==="BackupModal"),M=w(()=>e.disks.map(r=>({...r,name:r.name+" — ["+r.driver+"]"}))),V=w(()=>({currentBackupData:{option:{required:j.withMessage(p("validation.required"),A)},selected_disk:{required:j.withMessage(p("validation.required"),A)}}})),g=Y(V,w(()=>n));async function z(){if(g.value.currentBackupData.$touch(),g.value.currentBackupData.$invalid)return!0;let r={option:n.currentBackupData.option,file_disk_id:n.currentBackupData.selected_disk.id};try{m.value=!0,(await n.createBackup(r)).data&&(m.value=!1,a.refreshData&&a.refreshData(),a.closeModal())}catch{m.value=!1}}async function N(){_.value=!0;let r=await e.fetchDisks({limit:"all"});n.currentBackupData.selected_disk=r.data.data[0],_.value=!1}function C(){a.closeModal(),setTimeout(()=>{g.value.$reset(),n.$reset()})}return(r,h)=>{const t=c("BaseIcon"),i=c("BaseMultiselect"),d=c("BaseInputGroup"),u=c("BaseInputGrid"),v=c("BaseButton"),T=c("BaseModal");return L(),F(T,{show:s(k),onClose:C,onOpen:N},{header:l(()=>[D("div",oe,[$(S(s(a).title)+" ",1),o(t,{name:"XIcon",class:"w-6 h-6 text-gray-500 cursor-pointer",onClick:C})])]),default:l(()=>[D("form",{onSubmit:ee(z,["prevent"])},[D("div",le,[o(u,{layout:"one-column"},{default:l(()=>[o(d,{label:r.$t("settings.backup.select_backup_type"),error:s(g).currentBackupData.option.$error&&s(g).currentBackupData.option.$errors[0].$message,horizontal:"",required:"",class:"py-2"},{default:l(()=>[o(i,{modelValue:s(n).currentBackupData.option,"onUpdate:modelValue":h[0]||(h[0]=B=>s(n).currentBackupData.option=B),options:s(f),"can-deselect":!1,placeholder:r.$t("settings.backup.select_backup_type"),searchable:""},null,8,["modelValue","options","placeholder"])]),_:1},8,["label","error"]),o(d,{label:r.$t("settings.disk.select_disk"),error:s(g).currentBackupData.selected_disk.$error&&s(g).currentBackupData.selected_disk.$errors[0].$message,horizontal:"",required:"",class:"py-2"},{default:l(()=>[o(i,{modelValue:s(n).currentBackupData.selected_disk,"onUpdate:modelValue":h[1]||(h[1]=B=>s(n).currentBackupData.selected_disk=B),"content-loading":s(_),options:s(M),searchable:!0,"allow-empty":!1,label:"name","value-prop":"id",placeholder:r.$t("settings.disk.select_disk"),"track-by":"name",object:""},null,8,["modelValue","content-loading","options","placeholder"])]),_:1},8,["label","error"])]),_:1})]),D("div",re,[o(v,{class:"mr-3",variant:"primary-outline",type:"button",onClick:C},{default:l(()=>[$(S(r.$t("general.cancel")),1)]),_:1}),o(v,{loading:s(m),disabled:s(m),variant:"primary",type:"submit"},{left:l(B=>[s(m)?Z("",!0):(L(),F(t,{key:0,name:"SaveIcon",class:R(B.class)},null,8,["class"]))]),default:l(()=>[$(" "+S(r.$t("general.create")),1)]),_:1},8,["loading","disabled"])])],40,ne)]),_:1},8,["show"])}}},ie={class:"grid my-14 md:grid-cols-3"},ue={class:"inline-block"},ke={setup(I){const m=te(),_=X(),f=E(),n=H(),{t:a}=O(),e=U({selected_disk:{driver:"local"}}),p=y("");let k=y(!0);const M=w(()=>[{key:"path",label:a("settings.backup.path"),thClass:"extra",tdClass:"font-medium text-gray-900"},{key:"created_at",label:a("settings.backup.created_at"),tdClass:"font-medium text-gray-900"},{key:"size",label:a("settings.backup.size"),tdClass:"font-medium text-gray-900"},{key:"actions",label:"",tdClass:"text-right text-sm font-medium",sortable:!1}]),V=w(()=>n.disks.map(t=>({...t,name:t.name+" — ["+t.driver+"]"})));N();function g(t){m.openDialog({title:a("general.are_you_sure"),message:a("settings.backup.backup_confirm_delete"),yesLabel:a("general.ok"),noLabel:a("general.cancel"),variant:"danger",hideNoButton:!1,size:"lg"}).then(async i=>{if(i){let d={disk:e.selected_disk.driver,file_disk_id:e.selected_disk.id,path:t.path},u=await _.removeBackup(d);if(u.data.success||u.data.backup)return p.value&&p.value.refresh(),!0}})}function z(){setTimeout(()=>{p.value.refresh()},100)}async function N(){k.value=!0;let t=await n.fetchDisks({limit:"all"});t.data.error,e.selected_disk=t.data.data.find(i=>i.set_as_default==0),k.value=!1}async function C({page:t,filter:i,sort:d}){let u={disk:e.selected_disk.driver,filed_disk_id:e.selected_disk.id};k.value=!0;let v=await _.fetchBackups(u);return k.value=!1,{data:v.data.backups,pagination:{totalPages:1,currentPage:1}}}async function r(){f.openModal({title:a("settings.backup.create_backup"),componentName:"BackupModal",refreshData:p.value&&p.value.refresh,size:"sm"})}async function h(t){k.value=!0,window.axios({method:"GET",url:"/api/v1/download-backup",responseType:"blob",params:{disk:e.selected_disk.driver,file_disk_id:e.selected_disk.id,path:t.path}}).then(i=>{const d=window.URL.createObjectURL(new Blob([i.data])),u=document.createElement("a");u.href=d,u.setAttribute("download",t.path.split("/")[1]),document.body.appendChild(u),u.click(),k.value=!1}).catch(i=>{k.value=!1})}return(t,i)=>{const d=c("BaseIcon"),u=c("BaseButton"),v=c("BaseMultiselect"),T=c("BaseInputGroup"),B=c("BaseDropdownItem"),J=c("BaseDropdown"),K=c("BaseTable"),Q=c("BaseSettingCard");return L(),ae(se,null,[o(ce),o(Q,{title:t.$t("settings.backup.title",1),description:t.$t("settings.backup.description")},{action:l(()=>[o(u,{variant:"primary-outline",onClick:r},{left:l(b=>[o(d,{class:R(b.class),name:"PlusIcon"},null,8,["class"])]),default:l(()=>[$(" "+S(t.$t("settings.backup.new_backup")),1)]),_:1})]),default:l(()=>[D("div",ie,[o(T,{label:t.$t("settings.disk.select_disk"),"content-loading":s(k)},{default:l(()=>[o(v,{modelValue:s(e).selected_disk,"onUpdate:modelValue":i[0]||(i[0]=b=>s(e).selected_disk=b),"content-loading":s(k),options:s(V),"track-by":"name",placeholder:t.$t("settings.disk.select_disk"),label:"name",searchable:!0,object:"",class:"w-full","value-prop":"id",onSelect:z},null,8,["modelValue","content-loading","options","placeholder"])]),_:1},8,["label","content-loading"])]),o(K,{ref:(b,q)=>{q.table=b,p.value=b},class:"mt-10","show-filter":!1,data:C,columns:s(M)},{"cell-actions":l(({row:b})=>[o(J,null,{activator:l(()=>[D("div",ue,[o(d,{name:"DotsHorizontalIcon",class:"text-gray-500"})])]),default:l(()=>[o(B,{onClick:q=>h(b.data)},{default:l(()=>[o(d,{name:"CloudDownloadIcon",class:"mr-3 text-gray-600"}),$(" "+S(t.$t("general.download")),1)]),_:2},1032,["onClick"]),o(B,{onClick:q=>g(b.data)},{default:l(()=>[o(d,{name:"TrashIcon",class:"mr-3 text-gray-600"}),$(" "+S(t.$t("general.delete")),1)]),_:2},1032,["onClick"])]),_:2},1024)]),_:1},8,["columns"])]),_:1},8,["title","description"])],64)}}};export{ke as default};
